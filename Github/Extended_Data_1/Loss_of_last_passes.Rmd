---
title: "Loss of last pass"
author: "James Whipman"
date: "2025-03-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(EBImage) 
library(RANN)  
library(SingleCellExperiment)
library(ggplot2)
library(scuttle)
library(ggpubr)
library(BiocParallel)
library(reshape2)
library(dplyr)
library(ggrepel)
```


##IMC-IF alignment and comparison of PSF
Read in the transformation matrix and the IMC TIFF and get into the same sce object (potentially as another assay?)

```{r}
IF_consec <- EBImage::readImage("/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_1/Combined_nucleoli_regions.tif", all = TRUE, type = "tiff")
IMC_consec <- EBImage::readImage("/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_1/Nucleoli_HRIMC_unprocessed.tiff", all = TRUE, type = "tiff")
IMC_consec <-IMC_consec[4:(dim(IMC_consec)[1]-3), 4:(dim(IMC_consec)[2]-3), 1:5]
IMC_convolved <- EBImage::readImage("/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_1/convolved_size_retained.tiff", all = TRUE, type = "tiff")
IMC_processed_consec <- EBImage::readImage("/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_1/processed_x0_7.0.tiff", all = TRUE, type = "tiff")
```


#Assessing PSF performance
Need to select multiple small areas where sub-micron structures can be analysed. The goal is to compare how the PSF, vs oversampled vs convolved compare ot the underlying IF image
The challenge is adapting the transformation matrix for alignment as one side of the tissue may align less well due to changes in tissue processing, drying, warping etc. 
Transformation matrices must be developed for each area to fine tune the alignment to sub-micron accuracy. 

```{r Function to assess PSF performance}
IF_correlations <- function(IF_consec, IMC_consec, IMC_convolved, x1, x2, y1, y2, transformation_matrix) {
    channel_data <- lapply(1:dim(IF_consec)[3], function(x) as.vector(imageData(IF_consec)[,,x]))
    counts <- as.data.frame(channel_data)
    colnames(counts) <-c("ATP5A", "SMA", "Hoechst")
    coords <- expand.grid(x = 0:(dim(IF_consec)[1]-1), y = 0:(dim(IF_consec)[2]-1))
    coords <- as.matrix(cbind(coords$x, coords$y, 1))
    sce <- SingleCellExperiment(assays = list(counts = t(counts)))
    transformed_coords <- coords %*% as.matrix(t(transformation_matrix))
    sce$Center_X <- transformed_coords[,1]
    sce$Center_Y <- transformed_coords[,2]
    
    channel_data <- lapply(1:dim(IMC_processed_consec)[3], function(x) as.vector(imageData(IMC_processed_consec)[,,x]))
    counts <- as.data.frame(channel_data)
    colnames(counts) <- c("SMA", "Xe134", "ATP5A", "DNA1", "DNA2")
    coords <- expand.grid(x = 0:(dim(IMC_processed_consec)[1]-1), y = 0:(dim(IMC_processed_consec)[2]-1))
    sce_imc <- SingleCellExperiment(assays = list(counts = t(counts)))
    sce_imc$Center_X <- coords[,1]
    sce_imc$Center_Y <- coords[,2]
    
    
    sce_imc <- sce_imc[,sce_imc$Center_Y >= y1 & sce_imc$Center_Y <= y2 &
                            sce_imc$Center_X >= x1 & sce_imc$Center_X <= x2]
    
    sce <- sce[,sce$Center_X >= min(sce_imc$Center_X) & sce$Center_X < max(sce_imc$Center_X) &
              sce$Center_Y >= min(sce_imc$Center_Y) & sce$Center_Y <max(sce_imc$Center_Y)]
    
    #Assign IF pixels to IMC pixels (based on the nearest IMC pixel)
    IF_coords <- cbind(sce$Center_X, sce$Center_Y)
    result <- RANN::nn2(coords, IF_coords, k = 1)
    sce$IMC_pixel <- as.vector(result[[1]])
    
    #Get mean IF values for each IMC pixel (may take some time)
    sce_IF <- aggregateAcrossCells(sce, ids = sce$IMC_pixel, statistics = "mean", use.assay.type = "counts", BPPARAM = MulticoreParam(RNGseed = 220427))
    
    #Read in the non-processed_image
    channel_data <- lapply(1:dim(IMC_consec)[3], function(x) as.vector(imageData(IMC_consec)[,,x]))
    counts <- as.data.frame(channel_data)
    colnames(counts) <- c("SMA", "Xe134", "ATP5A", "DNA1", "DNA2")
    coords <- expand.grid(x = 0:(dim(IMC_consec)[1]-1), y = 0:(dim(IMC_consec)[2]-1))
    sce_imc_pre <- SingleCellExperiment(assays = list(counts = t(counts)))
    sce_imc_pre$Center_X <- coords[,1]
    sce_imc_pre$Center_Y <- coords[,2]
    
    sce_imc_pre <- sce_imc_pre[,sce_imc_pre$Center_Y >= y1 & sce_imc_pre$Center_Y <= y2 &
                            sce_imc_pre$Center_X >= x1 & sce_imc_pre$Center_X <= x2]
    
    #READ IN THE CONVOLVED IMAGE
    channel_data <- lapply(1:dim(IMC_convolved)[3], function(x) as.vector(imageData(IMC_convolved)[,,x]))
    counts <- as.data.frame(channel_data)
    colnames(counts) <- c("SMA", "Xe134", "ATP5A", "DNA1", "DNA2")
    coords <- expand.grid(x = 0:(dim(IMC_convolved)[1]-1), y = 0:(dim(IMC_convolved)[2]-1))
    sce_imc_con <- SingleCellExperiment(assays = list(counts = t(counts)))
    sce_imc_con$Center_X <- coords[,1] - 3
    sce_imc_con$Center_Y <- coords[,2] - 3
    
    sce_imc_con <- sce_imc_con[,sce_imc_con$Center_Y >= y1 & sce_imc_con$Center_Y <= y2 &
                            sce_imc_con$Center_X >= x1 & sce_imc_con$Center_X <= x2]
    
    #DATA TRANSFORMATIONS
    assay(sce_IF, "exprs") <- asinh(assay(sce_IF, "counts"))
    assay(sce_IF, "scaled") <- t(scale(t(assay(sce_IF, "exprs"))))
    cell_norm_counts <- t(apply(assay(sce_IF, "counts"), 1, function(x)(x-min(x))/(quantile(x, 0.99)-min(x))))
    cell_norm_counts <- t(apply(cell_norm_counts, 1, function(x) pmin(x, 1)))
    assay(sce_IF, "normalized", withDimnames = FALSE) <- cell_norm_counts
    
    assay(sce_imc, "exprs") <- asinh(assay(sce_imc, "counts"))
    assay(sce_imc, "scaled") <- t(scale(t(assay(sce_imc, "exprs"))))
    cell_norm_counts <- t(apply(assay(sce_imc, "counts"), 1, function(x)(x-min(x))/(quantile(x, 0.99)-min(x))))
    cell_norm_counts <- t(apply(cell_norm_counts, 1, function(x) pmin(x, 1)))
    assay(sce_imc, "normalized", withDimnames = FALSE) <- cell_norm_counts
    
    assay(sce_imc_pre, "exprs") <- asinh(assay(sce_imc_pre, "counts"))
    assay(sce_imc_pre, "scaled") <- t(scale(t(assay(sce_imc_pre, "exprs"))))
    cell_norm_counts <- t(apply(assay(sce_imc_pre, "counts"), 1, function(x)(x-min(x))/(quantile(x, 0.99)-min(x))))
    cell_norm_counts <- t(apply(cell_norm_counts, 1, function(x) pmin(x, 1)))
    assay(sce_imc_pre, "normalized", withDimnames = FALSE) <- cell_norm_counts
    
    assay(sce_imc_con, "exprs") <- asinh(assay(sce_imc_con, "counts"))
    assay(sce_imc_con, "scaled") <- t(scale(t(assay(sce_imc_con, "exprs"))))
    cell_norm_counts <- t(apply(assay(sce_imc_con, "counts"), 1, function(x)(x-min(x))/(quantile(x, 0.99)-min(x))))
    cell_norm_counts <- t(apply(cell_norm_counts, 1, function(x) pmin(x, 1)))
    assay(sce_imc_con, "normalized", withDimnames = FALSE) <- cell_norm_counts
    
    colnames(sce_imc) <- 1:ncol(sce_imc)
    sce_imc_o <- sce_imc[c("ATP5A", "SMA", "DNA1"),]
    sce_imc_p <- sce_imc_pre[c("ATP5A", "SMA", "DNA1"),]
    sce_imc_c <- sce_imc_con[c("ATP5A", "SMA", "DNA1"),]
    sce_IF$Center_X <- sce_imc_o$Center_X
    sce_IF$Center_Y <- sce_imc_o$Center_Y
    
    Oversampled <- cor(t(assay(sce_imc_p, "normalized")), t(assay(sce_IF, "normalized")),  method = "spearman")[3,3]
    PSF_transformed <- cor(t(assay(sce_imc_o, "normalized")), t(assay(sce_IF, "normalized")),  method = "spearman")[3,3]
    Normal <- cor(t(assay(sce_imc_c, "normalized")), t(assay(sce_IF, "normalized")), method = "spearman")[3,3]
    return(c(Normal,Oversampled, PSF_transformed))
    
}
```

```{r} 
transformation_matrix_1 <- as.matrix(read.csv("/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_1/transformation_matrix_1.csv"))
transformation_matrix_2 <- as.matrix(read.csv("/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_1/transformation_matrix_2.csv"))
transformation_matrix_3 <- as.matrix(read.csv("/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_1/transformation_matrix_3.csv"))
```


The below script is for Extended Data 1f. It measures the effect of removing laser passes on the PSF transformation.
```{r}
data_append <- data.frame(data[data$Method == "Oversampled",])

for (file in list.files("/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Extended_Data_1/img_last_pass/")) {
  IMC_processed_consec <- EBImage::readImage(paste0("/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Extended_Data_1/img_last_pass/", file), all = TRUE, type = "tiff")
  Nucleolus_one <- IF_correlations(IF_consec, IMC_consec, IMC_convolved, 1554, 1566, 369, 375, transformation_matrix_1)
  Nucleolus_two <- IF_correlations(IF_consec, IMC_consec, IMC_convolved, 1265, 1276, 268, 274, transformation_matrix_2)
  Nucleolus_three <- IF_correlations(IF_consec, IMC_consec, IMC_convolved, 1582, 1593, 363, 369, transformation_matrix_3)
  data <- cbind(Nucleolus_one, Nucleolus_two, Nucleolus_three)
  rownames(data) <- c("IMC", "Oversampled", file)
  data <- melt(data)
  colnames(data) <- c("Method", "Nucleolus", "Correlation")
  data_append <- rbind(data_append, data[data$Method == file,])
}

data_append$POI <- c(rep("Oversampled", 3), rep("Loss of 8-9th", 3), rep("Loss of 9th", 3), rep("All passes", 3), rep("Loss of 7-9th", 3))
mean_values <- data_append %>% group_by(POI) %>% summarize(mean_value = mean(Correlation))

```


```{r plotting}

data_append$POI <- factor(data_append$POI, levels = c("Oversampled", "Loss of 7-9th", "Loss of 8-9th", "Loss of 9th", "All passes"))

ggplot(data_append, aes(x = POI, y = Correlation, fill = POI, color = POI)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.5, size = 3, stroke = 0.5, aes(color = POI)) +
  geom_label_repel(data = mean_values, aes(x = POI, y = mean_value, label = sprintf("hat(mu)== %.2f", mean_value)), 
                   parse = TRUE, size = 3, fill = "white", color = "black", 
                   nudge_x = 0.4, nudge_y = 0, direction = "x", segment.linetype = 4) +
  labs(title = "Correlation by Method", x = "Method", y = "Correlation") +        # Add text labels on top of bars
  scale_fill_manual(values = c(alpha("#204a77",0.5), alpha("#A90C38",0.6), alpha("#F5B35E", 0.6), alpha("#B10065",0.6),  alpha("#740580",0.6))) + 
  scale_color_manual(values = c("#204a77", "#A90C38", "#F5B35E", "#B10065", "#740580")) +
  theme_minimal() +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1),
        axis.text.x = element_text(angle = 25, hjust = 1)) +
  stat_compare_means(
    comparisons = list(c("Loss of 7-9th", "Oversampled"), c("Loss of 8-9th", "Oversampled"),c("Loss of 9th", "Oversampled"),c("All passes", "Oversampled")),
    method = "t.test", paired = FALSE, label = "value"
  )


```


