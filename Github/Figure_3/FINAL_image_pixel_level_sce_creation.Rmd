---
title: "Cell_pixel_extraction"
author: "James Whipman"
date: "2024-09-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(EBImage)
library(SingleCellExperiment)
library(CATALYST)
```

##Cell Pixel Extraction

This script enables us to extract the pixels from a folder of images and compile all of those images into an sce object. Critically, we store the pixel level data. For every pixel we
record the expression values, coordinates and apply a spillover correction. 

```{r RUN THIS FOR CONVOLVED DATA}
path_to_image <- "/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_3/Convolved_image/img/"
path_to_masks <- "/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_3/Convolved_image/masks/"
panel <- read.csv(file = "/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_3/Convolved_image/panel.csv", stringsAsFactors = FALSE)
```

```{r RUN THIS FOR HIGH RESOLUTION DATA}
path_to_image <- "/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_3/High_res_image/img/"
path_to_masks <- "/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_3/High_res_image/masks/"
panel <- read.csv(file = "/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_3/High_res_image/panel.csv"), stringsAsFactors = FALSE)
```



```{r}
spillover <- read.csv("/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_3/spillover.csv", row.names = 1)
```


```{r}
images <- list.files(path_to_image)
images <- images[1:2] #Select images for sce compiling
masks_files <- list.files(path_to_masks)

sce_objects <- lapply(1:length(images), function(x) {
  image_ECM <- EBImage::readImage(paste0(path_to_image, images[x]), all = TRUE, type = "tiff")
  masks <- EBImage::readImage(paste0(path_to_masks, masks_files[x]))
  mask_indices <- which(imageData(masks) != 0, arr.ind = TRUE)
  cells <- imageData(masks)[mask_indices]
  cellno <- setNames(1:length(unique(cells)), unique(cells))
  renamed <- cellno[as.character(cells)]

  channel_data <- lapply(1:dim(image_ECM)[3], function(x) imageData(image_ECM)[,,x][mask_indices])
  counts <- as.data.frame(channel_data)
  colnames(counts) <- panel$name <- gsub("^[^_]*_", "", panel$name)
  coords <- as.data.frame(mask_indices)

  sce <- SingleCellExperiment(assays = list(counts = t(counts)))
  sce$Center_X <- coords[,1]
  sce$Center_Y <- coords[,2]
  sce$image <- gsub("\\.tiff$", "", images[x])
  sce$cell <- paste0(renamed, "_", as.character(x))
  return(sce)
})

sce <- do.call(cbind, sce_objects)
```

#Spillover Correction
Now we read in the spillover correction matrix from the spillover script. We overwrite
the data and apply common IMC transformations

```{r spillover correction}
rowData(sce)$channel_name <- paste0(panel$channel, "Di")
sce <- compCytof(sce, spillover, 
                 transform = TRUE, cofactor = 1,
                 isotope_list = isotope_list, 
                 overwrite = TRUE)
```

```{r saving final}
saveRDS(sce, "/mnt/central_nas/projects/Pladioc/SRIMC_project/Zenodo/Figure_3/sce_corrected.RDS") #Modify as needed
```
